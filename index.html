<html ng-app="osApp">
  <head>
    <meta charset="utf-8">
    <title>Openstack Web App</title>
    <!-- Switch these to minified versions for production -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.7/angular.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.7/angular-cookies.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.7/angular-route.js"></script>
    <script>
      var osApp = angular.module('osApp', ['ngCookies', 'ngRoute']);

      osApp.config(function($routeProvider) {
        $routeProvider.
          when('/',{
            templateUrl: 'login.html',
            <!-- logged in ? redirect to /first_tenant/servers -->
            controller: 'loginCtrl'
          }).
          when('/tenants',{
            templateUrl: 'tenants.html',
            controller: 'tenantsCtrl'
          }).
          when('/:tenant_id/servers/',{
            templateUrl: 'servers.html',
            controller: 'serversCtrl'
          }).
          otherwise({
            redirectTo: '/'
          });
      });

      osApp.factory('sessionFactory', function($http, $cookies) {
        return {
          authenticate: authenticate,
          getTenantToken: getTenantToken
        };

        ////////

        <!-- must implement caching and expiration for tokens -->
        function authenticate(userName, password, callback){
          var requestData = {
                            "auth": {
                              "identity": {
                                "methods": [
                                  "password"
                                ],
                                "password": {
                                  "user": {
                                    "domain": {
                                      "name": "default"
                                    },
                                    "name": userName,
                                    "password": password
                                  }
                                }
                              }
                            }
                          };

          console.log(JSON.stringify(requestData, null, '  '));

          $http.post('http://192.168.122.183:35357/v3/auth/tokens', requestData)
            .success(function(data, status, headers){
              console.log('Token response header:\n' + JSON.stringify(headers(), null, '  '));
              console.log('Token response data:\n' + JSON.stringify(data, null, '  '));

              $http.defaults.headers.common['X-Auth-Token'] = headers('X-Subject-Token');

              $cookies.put('X-Subject-Token', headers('X-Subject-Token'));
              console.log('|X-Subject-Token| = ' + $cookies.get('X-Subject-Token'));

              $cookies.put('X-Subject-Token-Expires', data.token.expires_at);
              console.log('|X-Subject-Token-Expires| = ' + $cookies.get('X-Subject-Token-Expires'));

              $cookies.put('user_id', data.token.user.id);
              console.log('|user_id| = ' + $cookies.get('user_id'));

              $cookies.putObject('user', {
                "user_id": data.token.user.id,
                "X-Auth-Token": headers('X-Subject-Token')
                <!-- Add token expiration date/time -->
              });
              console.log('|user| = ' + JSON.stringify($cookies.getObject('user'), null,' '));
              callback();
            }); <!-- add failure handling -->
        };

        function getToken() {
          return $cookies.get('X-Subject-Token');
        }

        function getTenantToken(tenant_id, callback) {
          var requestData = {
            "auth": {
              "token": {
                "id": getToken()
              },
              "tenantId": tenant_id
            }
          };

          console.log('sessionFactory:getTenantToken - Request data\n' + JSON.stringify(requestData, null, '  '));

          $http.post('http://192.168.122.183:35357/v2.0/tokens', requestData)
            .success(function(data) {
              console.log('sessionFactory:getTenantToken - Response data\n' + JSON.stringify(data, null, '  '));
              $http.defaults.headers.common['X-Auth-Token'] = data.access.token.id;
              callback(data.access.token.id);
            });

        }
      });

      osApp.controller('loginCtrl', function($scope, $http, $cookies, $window, sessionFactory){
        $scope.formData = { 'userName' : 'demo', 'password' : 'opstack' };

        console.log('cookie: ' + $cookies.get('X-Auth-Token'));

        $scope.processFunction = function() {
          sessionFactory.authenticate($scope.formData.userName, $scope.formData.password, function() {
            $window.location.href = '#/tenants';
          });
        };
      });

      osApp.factory('tenantsFactory', function($http) {
        function getData(callback) {
          $http.get('http://192.168.122.183:5000/v2.0/tenants')
          .success(function(data){
            console.log('common $http headers in tenantsFactory: \n', $http.defaults.headers.common)
            console.log('tenantsFactory response data:\n' + JSON.stringify(data, null, '  '));
            callback(data);
          }); <!-- add failure handling -->
        };

        return {
          getData: getData
        };
      });

      osApp.controller('tenantsCtrl', function($scope, $http, $cookies, tenantsFactory){
        $scope.tenants = [];
        $scope.sortField = 'name';
        $scope.reverse = false;

        tenantsFactory.getData(function(data) {
          $scope.tenants = data;
        });

      });

      osApp.factory('serversFactory', function($http, sessionFactory) {
        function getData(tenant_id, callback) {
          sessionFactory.getTenantToken(tenant_id, function(tenant_token) {
            console.log('serversFactory:getData - sessionFactory:getTenantToken - ' + tenant_token);
            // insert $http call to get tenant scoped servers and issue callback with servers hash
          });
        };

        return {
          getData: getData
        };
      });

      osApp.controller('serversCtrl', function($scope, $routeParams, tenantsFactory, serversFactory){
        $scope.tenants = {};

        $scope.servers = {};
        $scope.sortField = 'name';
        $scope.reverse = false;

        console.log('serversCtrl: $routeParams:\n' + JSON.stringify($routeParams, null, '  '));
        tenantsFactory.getData(function(data) {
          $scope.tenants = data;
          if ($scope.tenants.tenants[0]) {
            serversFactory.getData($scope.tenants.tenants[0].id, function(data) {
              $scope.servers = data;
            });
          }
        });
      });

    </script>
  </head>
  <body ng-view>
  </body>
</html>
